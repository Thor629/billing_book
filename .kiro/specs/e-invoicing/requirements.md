# Requirements Document

## Introduction

This document specifies the requirements for an e-invoicing system integrated with the existing sales invoice functionality. The system enables automatic e-invoice generation, IRN-based way bill generation, GSTR1 reconciliation, and seamless party selection from the existing parties database.

## Glossary

- **System**: The Flutter-based SaaS billing platform with e-invoicing capabilities
- **User**: A business owner or accountant who creates and manages invoices
- **E-Invoice**: An electronically generated invoice registered with the GST system
- **IRN**: Invoice Reference Number - a unique identifier generated by the GST system for each e-invoice
- **Way Bill**: A document required for transportation of goods, generated using IRN
- **GSTR1**: GST Return form for outward supplies
- **Party**: A customer or vendor registered in the system
- **GST System**: Government of India's Goods and Services Tax Network
- **QR Code**: Quick Response code containing invoice details for verification
- **Invoice Prefix**: A customizable text prefix for invoice numbers (e.g., "INV", "SHI")
- **Payment Terms**: Number of days within which payment is due
- **HSN/SAC**: Harmonized System of Nomenclature / Services Accounting Code
- **Auto Round Off**: Automatic rounding of invoice total to nearest rupee

## Requirements

### Requirement 1

**User Story:** As a user, I want to select a party from my existing parties list when creating an invoice, so that I can quickly populate customer details without manual entry.

#### Acceptance Criteria

1. WHEN a user clicks "Add Party" in the invoice creation form, THEN the System SHALL display a searchable list of all parties from the parties database
2. WHEN a user searches for a party by name, THEN the System SHALL filter the parties list in real-time
3. WHEN a user selects a party, THEN the System SHALL auto-populate billing address, GST number, contact details, and shipping address
4. WHEN a party is selected, THEN the System SHALL display the party name, phone, and email in the "Bill To" section
5. WHEN no parties exist, THEN the System SHALL provide an option to create a new party directly from the invoice screen

### Requirement 2

**User Story:** As a user, I want to add items to my invoice with automatic tax calculations, so that I can create accurate invoices quickly.

#### Acceptance Criteria

1. WHEN a user clicks "Add Item", THEN the System SHALL display a searchable list of items from the items database
2. WHEN a user selects an item, THEN the System SHALL auto-populate item name, HSN/SAC code, unit, and default price
3. WHEN a user enters quantity, THEN the System SHALL automatically calculate line total based on price, discount, and tax
4. WHEN a user changes discount percentage, THEN the System SHALL recalculate discount amount and line total
5. WHEN a user changes tax percentage, THEN the System SHALL recalculate tax amount and line total

### Requirement 3

**User Story:** As a user, I want the system to automatically calculate invoice totals including subtotal, discounts, taxes, and final amount, so that I avoid manual calculation errors.

#### Acceptance Criteria

1. WHEN items are added or modified, THEN the System SHALL automatically update the subtotal
2. WHEN discount is applied, THEN the System SHALL calculate and display the discount amount
3. WHEN additional charges are added, THEN the System SHALL include them in the total calculation
4. WHEN auto round-off is enabled, THEN the System SHALL round the total to the nearest rupee and display the round-off amount
5. WHEN payment amount is entered, THEN the System SHALL calculate and display the balance amount

### Requirement 4

**User Story:** As a user, I want to generate e-invoices automatically compliant with GST regulations, so that my invoices are legally valid and accepted by the GST system.

#### Acceptance Criteria

1. WHEN a user saves an invoice with GST-registered party, THEN the System SHALL generate an e-invoice request to the GST system
2. WHEN the GST system approves the e-invoice, THEN the System SHALL store the IRN with the invoice
3. WHEN an e-invoice is generated, THEN the System SHALL generate and display a QR code containing invoice details
4. WHEN e-invoice generation fails, THEN the System SHALL display the error message from GST system and save the invoice as draft
5. WHEN an e-invoice is generated, THEN the System SHALL mark the invoice as "E-Invoice Generated" with IRN visible

### Requirement 5

**User Story:** As a user, I want to generate way bills using IRN for hassle-free goods transportation, so that I comply with transportation regulations.

#### Acceptance Criteria

1. WHEN an e-invoice with IRN exists, THEN the System SHALL provide an option to generate way bill
2. WHEN a user clicks "Generate Way Bill", THEN the System SHALL use the IRN to create a way bill through the GST system
3. WHEN a way bill is generated, THEN the System SHALL store the way bill number with the invoice
4. WHEN a way bill is generated, THEN the System SHALL allow the user to download or print the way bill
5. WHEN way bill generation fails, THEN the System SHALL display the error message and allow retry

### Requirement 6

**User Story:** As a user, I want easy GSTR1 reconciliation, so that I can file my GST returns accurately and efficiently.

#### Acceptance Criteria

1. WHEN a user accesses GSTR1 reconciliation, THEN the System SHALL display all e-invoices for the selected period
2. WHEN displaying invoices, THEN the System SHALL show invoice number, party name, invoice amount, tax amount, and IRN
3. WHEN a user selects a date range, THEN the System SHALL filter invoices within that range
4. WHEN a user clicks "Export for GSTR1", THEN the System SHALL generate a file in GSTR1-compatible format
5. WHEN reconciliation is complete, THEN the System SHALL mark invoices as "Reconciled" with reconciliation date

### Requirement 7

**User Story:** As a user, I want to configure invoice settings including prefix, starting number, and default terms, so that invoices match my business requirements.

#### Acceptance Criteria

1. WHEN a user accesses invoice settings, THEN the System SHALL display options for invoice prefix, starting number, and payment terms
2. WHEN a user changes the invoice prefix, THEN the System SHALL apply it to all new invoices
3. WHEN a user sets default payment terms, THEN the System SHALL auto-calculate due date based on invoice date
4. WHEN a user enables auto round-off, THEN the System SHALL automatically round all invoice totals
5. WHEN a user configures bank details, THEN the System SHALL display them on invoices when "Show Bank Details" is enabled

### Requirement 8

**User Story:** As a user, I want to add custom notes and terms & conditions to my invoices, so that I can communicate important information to customers.

#### Acceptance Criteria

1. WHEN a user clicks "Add Notes", THEN the System SHALL display a text field for entering custom notes
2. WHEN a user adds terms & conditions, THEN the System SHALL display them at the bottom of the invoice
3. WHEN a user saves custom terms, THEN the System SHALL store them as templates for future use
4. WHEN creating a new invoice, THEN the System SHALL auto-populate default terms & conditions if configured
5. WHEN printing or downloading invoice, THEN the System SHALL include notes and terms & conditions

### Requirement 9

**User Story:** As a user, I want to record partial or full payments against invoices, so that I can track outstanding balances accurately.

#### Acceptance Criteria

1. WHEN a user enters payment amount, THEN the System SHALL calculate and display the balance amount
2. WHEN a user selects payment mode, THEN the System SHALL record it with the payment
3. WHEN a user marks invoice as "fully paid", THEN the System SHALL set payment amount equal to total amount
4. WHEN payment is recorded, THEN the System SHALL update the invoice payment status (unpaid, partially paid, paid)
5. WHEN an invoice is fully paid, THEN the System SHALL update the payment status to "Paid" and set balance to zero

### Requirement 10

**User Story:** As a user, I want to save invoices and create new ones quickly, so that I can process multiple invoices efficiently.

#### Acceptance Criteria

1. WHEN a user clicks "Save", THEN the System SHALL validate all required fields before saving
2. WHEN validation fails, THEN the System SHALL highlight missing or invalid fields with error messages
3. WHEN an invoice is saved successfully, THEN the System SHALL display a success message and return to invoice list
4. WHEN a user clicks "Save & New", THEN the System SHALL save the current invoice and open a blank invoice form
5. WHEN saving an invoice, THEN the System SHALL auto-increment the invoice number for the next invoice

### Requirement 11

**User Story:** As a user, I want to scan barcodes to quickly add items to invoices, so that I can speed up invoice creation for retail transactions.

#### Acceptance Criteria

1. WHEN a user clicks the barcode scanner icon, THEN the System SHALL activate the device camera or barcode scanner
2. WHEN a barcode is scanned, THEN the System SHALL search for the item by barcode in the items database
3. WHEN an item is found, THEN the System SHALL add it to the invoice with quantity 1
4. WHEN the same item is scanned again, THEN the System SHALL increment the quantity instead of adding a duplicate line
5. WHEN a barcode is not found, THEN the System SHALL display an error message and allow manual item selection

### Requirement 12

**User Story:** As a user, I want to apply discounts and additional charges at invoice level, so that I can handle special pricing scenarios.

#### Acceptance Criteria

1. WHEN a user clicks "Add Discount", THEN the System SHALL display options for percentage or fixed amount discount
2. WHEN a discount is applied, THEN the System SHALL recalculate the taxable amount and total
3. WHEN a user clicks "Add Additional Charges", THEN the System SHALL display a field to enter charge amount and description
4. WHEN additional charges are added, THEN the System SHALL include them in the total amount calculation
5. WHEN discounts or charges are modified, THEN the System SHALL update all dependent calculations in real-time

### Requirement 13

**User Story:** As a developer, I want the backend API to support e-invoice generation through GST system integration, so that the frontend can trigger e-invoice creation.

#### Acceptance Criteria

1. WHEN the backend receives an e-invoice generation request, THEN the System SHALL validate all required GST fields are present
2. WHEN validation passes, THEN the System SHALL send the invoice data to the GST e-invoice API
3. WHEN the GST system returns IRN, THEN the System SHALL store it with the invoice and generate QR code
4. WHEN the GST system returns an error, THEN the System SHALL return the error message to the frontend
5. WHEN an e-invoice is generated, THEN the System SHALL log the transaction with timestamp and response details

### Requirement 14

**User Story:** As a user, I want to view and download generated e-invoices with QR codes, so that I can share them with customers and tax authorities.

#### Acceptance Criteria

1. WHEN an e-invoice is generated, THEN the System SHALL display the QR code on the invoice
2. WHEN a user clicks "Download", THEN the System SHALL generate a PDF with the QR code and IRN
3. WHEN a user clicks "Print", THEN the System SHALL open a print dialog with the formatted invoice
4. WHEN viewing an invoice, THEN the System SHALL display the IRN prominently if e-invoice is generated
5. WHEN sharing an invoice, THEN the System SHALL include the QR code for verification by recipients

### Requirement 15

**User Story:** As a user, I want to edit draft invoices before finalizing them, so that I can correct errors without creating new invoices.

#### Acceptance Criteria

1. WHEN a user saves an invoice without generating e-invoice, THEN the System SHALL mark it as "Draft"
2. WHEN a user opens a draft invoice, THEN the System SHALL allow editing all fields
3. WHEN a user finalizes a draft invoice, THEN the System SHALL generate the e-invoice and mark it as "Final"
4. WHEN an invoice is marked as final with e-invoice, THEN the System SHALL prevent further editing
5. WHEN a user attempts to edit a finalized invoice, THEN the System SHALL display a message that editing is not allowed
